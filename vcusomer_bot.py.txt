# -*- coding: utf-8 -*-
import asyncio
import logging
import os
import threading
from flask import Flask

from aiogram import Bot, Dispatcher, types, F
from aiogram.filters import Command
from aiogram.fsm.context import FSMContext
from aiogram.fsm.state import State, StatesGroup
from aiogram.types import (
    ReplyKeyboardMarkup, KeyboardButton, InlineKeyboardMarkup,
    InlineKeyboardButton, ReplyKeyboardRemove
)

# --- –ù–ê–°–¢–†–û–ô–ö–ò ---
# –¢–æ–∫–µ–Ω –±—É–¥–µ—Ç –±—Ä–∞—Ç—å—Å—è –∏–∑ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ Render
# –≠—Ç–æ —Å–∞–º—ã–π –±–µ–∑–æ–ø–∞—Å–Ω—ã–π —Å–ø–æ—Å–æ–±, —á—Ç–æ–±—ã –Ω–µ "—Å–≤–µ—Ç–∏—Ç—å" —Ç–æ–∫–µ–Ω –≤ –∫–æ–¥–µ
TOKEN = os.environ.get('TOKEN')

# –í–∫–ª—é—á–∞–µ–º –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ
logging.basicConfig(level=logging.INFO)

# --- –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø ---
# –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –≤–µ–±-—Å–µ—Ä–≤–µ—Ä Flask, –∫–æ—Ç–æ—Ä—ã–π –Ω–µ –¥–∞—Å—Ç –±–æ—Ç—É "—É—Å–Ω—É—Ç—å"
app = Flask(__name__)
# –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –±–æ—Ç–∞ –∏ –¥–∏—Å–ø–µ—Ç—á–µ—Ä aiogram
bot = Bot(token=TOKEN)
dp = Dispatcher()

# --- –í–ï–ë-–ß–ê–°–¢–¨ –î–õ–Ø "–ü–†–û–ë–£–ñ–î–ï–ù–ò–Ø" ---
# –°–æ–∑–¥–∞–µ–º –ø—Ä–æ—Å—Ç–æ–π –º–∞—Ä—à—Ä—É—Ç, –∫–æ—Ç–æ—Ä—ã–π –±—É–¥–µ—Ç "–ø–∏–Ω–≥–æ–≤–∞—Ç—å" UptimeRobot
@app.route('/')
def index():
    return "Bot is alive and running!"

# --- –õ–û–ì–ò–ö–ê –ë–û–¢–ê (FSM, –∫–ª–∞–≤–∏–∞—Ç—É—Ä—ã, –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏) ---

# 1. –°–æ—Å—Ç–æ—è–Ω–∏—è –¥–ª—è –∞–Ω–∫–µ—Ç—ã
class Survey(StatesGroup):
    gender = State()
    goal = State()
    age = State()
    height = State()
    weight = State()
    activity = State()
    allergies = State()

# 2. –ö–ª–∞–≤–∏–∞—Ç—É—Ä—ã
start_kb = ReplyKeyboardMarkup(keyboard=[[KeyboardButton(text="–ü–æ–≥–Ω–∞–ª–∏! üöÄ")]], resize_keyboard=True)
gender_kb = ReplyKeyboardMarkup(keyboard=[[KeyboardButton(text="–ú—É–∂—Å–∫–æ–π"), KeyboardButton(text="–ñ–µ–Ω—Å–∫–∏–π")]], resize_keyboard=True)
goal_kb = ReplyKeyboardMarkup(keyboard=[[KeyboardButton(text="–ü–æ—Ö—É–¥–µ—Ç—å"), KeyboardButton(text="–ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞—Ç—å –≤–µ—Å"), KeyboardButton(text="–ù–∞–±—Ä–∞—Ç—å –º–∞—Å—Å—É")]], resize_keyboard=True)
activity_kb = ReplyKeyboardMarkup(keyboard=[[KeyboardButton(text="–°–∏–¥—è—á–∏–π –æ–±—Ä–∞–∑ –∂–∏–∑–Ω–∏"), KeyboardButton(text="–°—Ä–µ–¥–Ω—è—è –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å"), KeyboardButton(text="–í—ã—Å–æ–∫–∞—è –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å")]], resize_keyboard=True)

# 3. –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –∫–æ–º–∞–Ω–¥ –∏ —Å–æ–æ–±—â–µ–Ω–∏–π

# –ü—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ
@dp.message(Command("start"))
async def cmd_start(message: types.Message):
    await message.answer(
        "–ü—Ä–∏–≤–µ—Ç! –Ø ‚Äî –í–∫—É—Å–æ–º–µ—Ä ü•ó.\n"
        "–¢–≤–æ–π –∫–∞—Ä–º–∞–Ω–Ω—ã–π —à–µ—Ñ-–ø–æ–≤–∞—Ä –∏ –¥–∏–µ—Ç–æ–ª–æ–≥. –Ø –ø–æ–º–æ–≥—É —Ç–µ–±–µ –µ—Å—Ç—å –≤–∫—É—Å–Ω–æ, —Ö—É–¥–µ—Ç—å –∏ –ø—Ä–∏ —ç—Ç–æ–º –Ω–µ –ø—Ä–æ–≤–æ–¥–∏—Ç—å –Ω–∞ –∫—É—Ö–Ω–µ –±–æ–ª—å—à–µ 15 –º–∏–Ω—É—Ç.\n\n"
        "–î–∞–≤–∞–π –Ω–∞—Å—Ç—Ä–æ–∏–º —Ç–≤–æ–π –ª–∏—á–Ω—ã–π –ø–ª–∞–Ω?",
        reply_markup=start_kb
    )

# –ù–∞—á–∞–ª–æ –∞–Ω–∫–µ—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
@dp.message(F.text == "–ü–æ–≥–Ω–∞–ª–∏! üöÄ")
async def start_survey(message: types.Message, state: FSMContext):
    await message.answer("–í—ã–±–µ—Ä–∏ —Å–≤–æ–π –ø–æ–ª:", reply_markup=gender_kb)
    await state.set_state(Survey.gender)

@dp.message(Survey.gender, F.text.in_(["–ú—É–∂—Å–∫–æ–π", "–ñ–µ–Ω—Å–∫–∏–π"]))
async def process_gender(message: types.Message, state: FSMContext):
    await state.update_data(gender=message.text)
    await message.answer("–ö–∞–∫–∞—è —É —Ç–µ–±—è —Ü–µ–ª—å?", reply_markup=goal_kb)
    await state.set_state(Survey.goal)

@dp.message(Survey.goal, F.text.in_(["–ü–æ—Ö—É–¥–µ—Ç—å", "–ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞—Ç—å –≤–µ—Å", "–ù–∞–±—Ä–∞—Ç—å –º–∞—Å—Å—É"]))
async def process_goal(message: types.Message, state: FSMContext):
    await state.update_data(goal=message.text)
    await message.answer("–ö–∞–∫–æ–π —É —Ç–µ–±—è —É—Ä–æ–≤–µ–Ω—å –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏?", reply_markup=activity_kb)
    await state.set_state(Survey.activity)

@dp.message(Survey.activity, F.text.in_(["–°–∏–¥—è—á–∏–π –æ–±—Ä–∞–∑ –∂–∏–∑–Ω–∏", "–°—Ä–µ–¥–Ω—è—è –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å", "–í—ã—Å–æ–∫–∞—è –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å"]))
async def process_activity(message: types.Message, state: FSMContext):
    await state.update_data(activity=message.text)
    await message.answer("–í–≤–µ–¥–∏ —Å–≤–æ–π –≤–æ–∑—Ä–∞—Å—Ç (–ø–æ–ª–Ω—ã—Ö –ª–µ—Ç):", reply_markup=ReplyKeyboardRemove())
    await state.set_state(Survey.age)

@dp.message(Survey.age)
async def process_age(message: types.Message, state: FSMContext):
    if not message.text.isdigit() or not (10 < int(message.text) < 100):
        await message.answer("–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏ –≤–æ–∑—Ä–∞—Å—Ç —Ü–∏—Ñ—Ä–∞–º–∏ (–æ—Ç 10 –¥–æ 100).")
        return
    await state.update_data(age=int(message.text))
    await message.answer("–í–≤–µ–¥–∏ —Å–≤–æ–π —Ä–æ—Å—Ç (–≤ —Å–º):")
    await state.set_state(Survey.height)

@dp.message(Survey.height)
async def process_height(message: types.Message, state: FSMContext):
    if not message.text.isdigit() or not (100 < int(message.text) < 250):
        await message.answer("–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏ —Ä–æ—Å—Ç —Ü–∏—Ñ—Ä–∞–º–∏ (–≤ —Å–º).")
        return
    await state.update_data(height=int(message.text))
    await message.answer("–í–≤–µ–¥–∏ —Å–≤–æ–π –≤–µ—Å (–≤ –∫–≥, –º–æ–∂–Ω–æ —á–µ—Ä–µ–∑ —Ç–æ—á–∫—É, –Ω–∞–ø—Ä–∏–º–µ—Ä 65.5):")
    await state.set_state(Survey.weight)

# –§–∏–ª—å—Ç—Ä –∞–ª–ª–µ—Ä–≥–∏–π
@dp.message(Survey.weight)
async def process_weight(message: types.Message, state: FSMContext):
    try:
        weight = float(message.text.replace(',', '.'))
        if not (30 < weight < 200):
            raise ValueError
    except ValueError:
        await message.answer("–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏ –≤–µ—Å –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ (–Ω–∞–ø—Ä–∏–º–µ—Ä, 65.5).")
        return
    await state.update_data(weight=weight)

    allergies_kb = InlineKeyboardMarkup(inline_keyboard=[
        [InlineKeyboardButton(text="‚ùå –õ–∞–∫—Ç–æ–∑–∞", callback_data="allergy_lactose")],
        [InlineKeyboardButton(text="‚ùå –ì–ª—é—Ç–µ–Ω", callback_data="allergy_gluten")],
        [InlineKeyboardButton(text="‚ùå –û—Ä–µ—Ö–∏", callback_data="allergy_nuts")],
        [InlineKeyboardButton(text="‚úÖ –Ø –≤—Å—ë –µ–º", callback_data="allergy_none")],
        [InlineKeyboardButton(text="‚û°Ô∏è –ü–æ–∫–∞–∑–∞—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç", callback_data="calculate_result")]
    ])
    await message.answer(
        "–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å –ø—Ä–µ–≤—ã—à–µ –≤—Å–µ–≥–æ! –ï—Å—Ç—å –ª–∏ –ø—Ä–æ–¥—É–∫—Ç—ã, –∫–æ—Ç–æ—Ä—ã–µ —Ç–µ–±–µ –Ω–µ–ª—å–∑—è? –û—Ç–º–µ—Ç—å –∏—Ö –∏ –Ω–∞–∂–º–∏ '–ü–æ–∫–∞–∑–∞—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç'.",
        reply_markup=allergies_kb
    )
    await state.set_state(Survey.allergies)
    await state.update_data(allergies=[])

# –û–±—Ä–∞–±–æ—Ç–∫–∞ –Ω–∞–∂–∞—Ç–∏–π –Ω–∞ –∫–Ω–æ–ø–∫–∏ –∞–ª–ª–µ—Ä–≥–∏–π
@dp.callback_query(Survey.allergies, F.data.startswith("allergy_"))
async def process_allergies(callback: types.CallbackQuery, state: FSMContext):
    allergy = callback.data.split("_")[1]
    user_data = await state.get_data()

    if allergy == "none":
        user_data['allergies'] = []
        await callback.answer("–í—Å–µ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è —Å–Ω—è—Ç—ã", show_alert=False)
    elif allergy in user_data['allergies']:
        user_data['allergies'].remove(allergy)
        await callback.answer(f"–£–±—Ä–∞–Ω–æ: {allergy}", show_alert=False)
    else:
        user_data['allergies'].append(allergy)
        await callback.answer(f"–î–æ–±–∞–≤–ª–µ–Ω–æ: {allergy}", show_alert=False)

    await state.update_data(allergies=user_data['allergies'])

# –í—ã–¥–∞—á–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞
@dp.callback_query(Survey.allergies, F.data == "calculate_result")
async def calculate_result(callback: types.CallbackQuery, state: FSMContext):
    data = await state.get_data()

    brm = (10 * data['weight']) + (6.25 * data['height']) - (5 * data['age'])
    brm += 5 if data['gender'] == "–ú—É–∂—Å–∫–æ–π" else -161

    activity_coeffs = {"–°–∏–¥—è—á–∏–π –æ–±—Ä–∞–∑ –∂–∏–∑–Ω–∏": 1.2, "–°—Ä–µ–¥–Ω—è—è –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å": 1.55, "–í—ã—Å–æ–∫–∞—è –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å": 1.725}
    calories = brm * activity_coeffs[data['activity']]

    if data['goal'] == "–ü–æ—Ö—É–¥–µ—Ç—å": calories -= 400
    elif data['goal'] == "–ù–∞–±—Ä–∞—Ç—å –º–∞—Å—Å—É": calories += 400

    allergies_str = ", ".join(data.get('allergies', [])) or "–Ω–µ—Ç"

    await callback.message.edit_text(
        f"–¢–≤–æ–π —Ä–∞—Å—á–µ—Ç: **{int(calories)} –∫–∫–∞–ª**.\n\n"
        f"–Ø —É–∂–µ –ø–æ–¥–æ–±—Ä–∞–ª –¥–ª—è —Ç–µ–±—è –º–µ–Ω—é –Ω–∞ —Å–µ–≥–æ–¥–Ω—è (—Å —É—á–µ—Ç–æ–º —Ç–≤–æ–∏—Ö –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–π: {allergies_str}). "
        f"–í—Å–µ —Ä–µ—Ü–µ–ø—Ç—ã –≥–æ—Ç–æ–≤—è—Ç—Å—è **–¥–æ 15 –º–∏–Ω—É—Ç**.",
        parse_mode="Markdown",
        reply_markup=InlineKeyboardMarkup(inline_keyboard=[
            [InlineKeyboardButton(text="–ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å –º–µ–Ω—é –Ω–∞ —Å–µ–≥–æ–¥–Ω—è üçΩ", callback_data="show_menu")]
        ])
    )
    await state.clear()

# –î–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏—è –º–µ–Ω—é –∏ —Å–ø–∏—Å–∫–∞ –ø–æ–∫—É–ø–æ–∫
@dp.callback_query(F.data == "show_menu")
async def show_menu(callback: types.CallbackQuery):
    await callback.message.answer(
        "üçΩ **–ú–µ–Ω—é –Ω–∞ —Å–µ–≥–æ–¥–Ω—è:**\n\n"
        "**–ó–∞–≤—Ç—Ä–∞–∫:** –°–∫—Ä–µ–º–±–ª —Å –∞–≤–æ–∫–∞–¥–æ (12 –º–∏–Ω).\n"
        "**–û–±–µ–¥:** –ö—É—Ä–∏–Ω–∞—è –≥—Ä—É–¥–∫–∞ –≤ –ø–∞–ø–∏–ª—å–æ—Ç–µ (15 –º–∏–Ω).\n"
        "**–£–∂–∏–Ω:** –°–∞–ª–∞—Ç —Å –Ω—É—Ç–æ–º –∏ —Ç—É–Ω—Ü–æ–º (10 –º–∏–Ω).",
        parse_mode="Markdown",
        reply_markup=InlineKeyboardMarkup(inline_keyboard=[
            [InlineKeyboardButton(text="üõí –°—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞—Ç—å —Å–ø–∏—Å–æ–∫ –ø–æ–∫—É–ø–æ–∫", callback_data="shop_list")]
        ])
    )
    await callback.answer()

@dp.callback_query(F.data == "shop_list")
async def show_shop_list(callback: types.CallbackQuery):
    await callback.message.answer(
        "üõí **–í–æ—Ç —Ç–≤–æ–π —Å–ø–∏—Å–æ–∫ –≤ –º–∞–≥–∞–∑–∏–Ω –Ω–∞ —Å–µ–≥–æ–¥–Ω—è:**\n\n"
        "**–û—Ç–¥–µ–ª –û–≤–æ—â–∏:**\n‚Äî –ê–≤–æ–∫–∞–¥–æ (1 —à—Ç)\n‚Äî –¢–æ–º–∞—Ç—ã —á–µ—Ä—Ä–∏ (1 —É–ø–∞–∫.)\n\n"
        "**–û—Ç–¥–µ–ª –ú—è—Å–æ/–†—ã–±–∞:**\n‚Äî –ö—É—Ä–∏–Ω–æ–µ —Ñ–∏–ª–µ (200–≥)\n‚Äî –¢—É–Ω–µ—Ü –∫–æ–Ω—Å–µ—Ä–≤–∏—Ä–æ–≤–∞–Ω–Ω—ã–π (1 –±–∞–Ω–æ—á–∫–∞)\n\n"
        "**–û—Ç–¥–µ–ª –ë–∞–∫–∞–ª–µ—è:**\n‚Äî –ù—É—Ç –∫–æ–Ω—Å–µ—Ä–≤–∏—Ä–æ–≤–∞–Ω–Ω—ã–π (1 –±–∞–Ω–æ—á–∫–∞)",
        parse_mode="Markdown"
    )

    await asyncio.sleep(2)
    await callback.message.answer(
        "–ü–æ–Ω—Ä–∞–≤–∏–ª–æ—Å—å? –≠—Ç–æ –±—ã–ª –ª–∏—à—å –¥–µ–º–æ-–¥–µ–Ω—å!\n"
        "–ß—Ç–æ–±—ã –ø–æ–ª—É—á–∏—Ç—å **–≥–æ—Ç–æ–≤—ã–π –ø–ª–∞–Ω –Ω–∞ –Ω–µ–¥–µ–ª—é**, –ø–æ–¥–ø–∏—à–∏—Å—å –Ω–∞ –Ω–∞—à –∑–∞–∫—Ä—ã—Ç—ã–π –∫–ª—É–±.\n\n"
        "–ê –ø–æ–∫–∞ –∑–∞–≥–ª—è–Ω–∏ –Ω–∞ –Ω–∞—à –æ—Å–Ω–æ–≤–Ω–æ–π –∫–∞–Ω–∞–ª —Å –ª–∞–π—Ñ—Ö–∞–∫–∞–º–∏ –±—ã—Å—Ç—Ä–æ–π –≥–æ—Ç–æ–≤–∫–∏!",
        parse_mode="Markdown",
        reply_markup=InlineKeyboardMarkup(inline_keyboard=[
            [InlineKeyboardButton(text="–ü–µ—Ä–µ–π—Ç–∏ –≤ –∫–∞–Ω–∞–ª '–í–∫—É—Å–æ–º–µ—Ä' üì¢", url="https://t.me/durov")], # –ó–ê–ú–ï–ù–ò–¢–¨ –ù–ê –°–°–´–õ–ö–£ –í–ê–®–ï–ì–û –ö–ê–ù–ê–õ–ê
            [InlineKeyboardButton(text="–û—Ñ–æ—Ä–º–∏—Ç—å –ø–æ–¥–ø–∏—Å–∫—É (290 —Ä—É–±/–º–µ—Å)", callback_data="subscribe")]
        ])
    )
    await callback.answer()

@dp.callback_query(F.data == "subscribe")
async def process_subscribe(callback: types.CallbackQuery):
    await callback.answer("–§—É–Ω–∫—Ü–∏—è –æ–ø–ª–∞—Ç—ã —Å–∫–æ—Ä–æ –±—É–¥–µ—Ç –¥–æ–±–∞–≤–ª–µ–Ω–∞!", show_alert=True)

# --- –§–£–ù–ö–¶–ò–Ø –ó–ê–ü–£–°–ö–ê –ë–û–¢–ê –ò –í–ï–ë-–°–ï–†–í–ï–†–ê ---
async def run_bot():
    """–ó–∞–ø—É—Å–∫–∞–µ—Ç –æ–ø—Ä–æ—Å Telegram –Ω–∞ –Ω–∞–ª–∏—á–∏–µ –Ω–æ–≤—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π."""
    await bot.delete_webhook(drop_pending_updates=True)
    await dp.start_polling(bot)

if __name__ == "__main__":
    # –ó–∞–ø—É—Å–∫–∞–µ–º –±–æ—Ç–∞ –≤ –æ—Ç–¥–µ–ª—å–Ω–æ–º –ø–æ—Ç–æ–∫–µ, —á—Ç–æ–±—ã –æ–Ω –Ω–µ –±–ª–æ–∫–∏—Ä–æ–≤–∞–ª –≤–µ–±-—Å–µ—Ä–≤–µ—Ä
    bot_thread = threading.Thread(target=lambda: asyncio.run(run_bot()))
    bot_thread.start()

    # –ó–∞–ø—É—Å–∫–∞–µ–º –≤–µ–±-—Å–µ—Ä–≤–µ—Ä. Render —Å–∞–º –æ–ø—Ä–µ–¥–µ–ª–∏—Ç –ø–æ—Ä—Ç —á–µ—Ä–µ–∑ –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é –æ–∫—Ä—É–∂–µ–Ω–∏—è PORT.
    port = int(os.environ.get("PORT", 5000))
    app.run(host='0.0.0.0', port=port)
